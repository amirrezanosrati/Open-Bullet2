name: OpenBullet2 - Use Pre-installed Docker

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Check existing Docker
      run: |
        echo "ğŸ” Checking pre-installed Docker..."
        docker --version || echo "Docker not in PATH"
        docker ps || echo "Docker not running"
        echo "âœ… Environment check completed"

    - name: Pull OpenBullet2 image
      run: |
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Docker Ø¨Ø¯ÙˆÙ† Ù†ØµØ¨
        docker pull mrinjamul/openbullet2:latest
        echo "âœ… Image pulled successfully"

    - name: Run OpenBullet2 container
      run: |
        docker run -d \
          --name openbullet2 \
          -p 8080:8080 \
          mrinjamul/openbullet2:latest
        
        sleep 40
        
        if docker ps | grep -q openbullet2; then
          echo "âœ… Container is running"
          docker logs openbullet2 | head -5
        else
          echo "âŒ Container failed to start"
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 15

    - name: Get public URL
      run: |
        URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "ğŸŒ URL: $URL"
        echo "URL=$URL" >> $GITHUB_ENV

    - name: Display info
      run: |
        echo "========================================"
        echo "ğŸ‰ OPENBULLET2 READY!"
        echo "========================================"
        echo "ğŸŒ Access: $URL"
        echo "ğŸ‘¤ Username: admin"
        echo "ğŸ” Password: admin"
        echo "========================================"

    - name: Keep alive
      run: |
        sleep 21600
