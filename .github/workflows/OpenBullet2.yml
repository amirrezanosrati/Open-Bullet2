name: OpenBullet2 Docker Correct

on:
  workflow_dispatch

jobs:
  run-ob2-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Run OB2 with correct Docker command
      run: |
        # استفاده از یک image که از قبل .NET دارد
        docker run -d \
          --name ob2 \
          -p 8080:8080 \
          -e ASPNETCORE_URLS=http://0.0.0.0:8080 \
          mcr.microsoft.com/dotnet/sdk:6.0 \
          bash -c "git clone https://github.com/openbullet/OpenBullet2.git && cd OpenBullet2 && dotnet run --project OpenBullet2.Web --urls http://0.0.0.0:8080"
        
        sleep 60

    - name: Check container status
      run: |
        docker ps
        docker logs ob2 --tail 20

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 20

    - name: Get URL
      run: |
        url=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "OpenBullet2 URL: $url"

    - name: Keep alive
      run: |
        sleep 3600
