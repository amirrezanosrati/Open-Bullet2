name: OB2 Alternative Method

on:
  workflow_dispatch

jobs:
  run-ob2-alternative:
    runs-on: ubuntu-latest

    steps:
    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y dotnet-sdk-6.0 git wget

    - name: Clone and build step by step
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        
        # بررسی ساختار
        echo "=== Directory Structure ==="
        find . -maxdepth 2 -type d | sort
        
        echo "=== Project Files ==="
        find . -name "*.csproj" -o -name "*.sln"

    - name: Build using solution file
      run: |
        cd OpenBullet2
        if [ -f "OpenBullet2.sln" ]; then
          echo "🔨 Building solution..."
          dotnet build OpenBullet2.sln --configuration Release -v detailed
        else
          echo "❌ No solution file found"
          exit 1
        fi

    - name: Run from build output
      run: |
        cd OpenBullet2
        # پیدا کردن خروجی build
        if [ -d "OpenBullet2/bin/Release/net6.0" ]; then
          cd OpenBullet2/bin/Release/net6.0
          dotnet OpenBullet2.dll --urls="http://0.0.0.0:8080" &
        elif [ -d "bin/Release/net6.0" ]; then
          cd bin/Release/net6.0
          dotnet OpenBullet2.dll --urls="http://0.0.0.0:8080" &
        else
          echo "❌ Build output not found"
          exit 1
        fi
        
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 20

    - name: Verify and setup Ngrok
      run: |
        if ps -p $OB2_PID > /dev/null; then
          echo "✅ OB2 is running"
          
          # راه اندازی Ngrok
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ./ngrok http 8080 &
          sleep 10
          
          URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
          echo "🌐 URL: $URL"
        else
          echo "❌ OB2 failed to start"
          exit 1
        fi

    - name: Wait
      run: |
        sleep 14400
