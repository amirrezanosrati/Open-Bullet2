name: OB2 Guaranteed

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest

    steps:
    - name: Method 1 - Direct run
      id: method1
      run: |
        sudo apt-get install -y dotnet-sdk-6.0
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        dotnet run --project OpenBullet2.Web --urls "http://0.0.0.0:8080" &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 45
        
        if ps -p $OB2_PID > /dev/null; then
          echo "✅ Method 1 successful"
          echo "METHOD=direct" >> $GITHUB_ENV
        else
          echo "❌ Method 1 failed"
        fi

    - name: Method 2 - Docker fallback
      if: steps.method1.outcome == 'failure'
      run: |
        docker run -d \
          --name ob2 \
          -p 8080:8080 \
          -v $(pwd):/app \
          -w /app \
          mcr.microsoft.com/dotnet/sdk:6.0 \
          bash -c "cd OpenBullet2 && dotnet run --project OpenBullet2.Web --urls http://0.0.0.0:8080"
        
        sleep 50
        docker ps
        echo "METHOD=docker" >> $GITHUB_ENV

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 &
        sleep 20

    - name: Display result
      run: |
        url=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "🎉 Success with method: $METHOD"
        echo "🌐 URL: $url"
        echo "👤 admin/admin"

    - name: Wait
      run: |
        sleep 7200
