name: OB2 Docker Guaranteed

on:
  workflow_dispatch

jobs:
  run-ob2-docker:
    runs-on: ubuntu-latest

    steps:
    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker

    - name: Run OB2 container
      run: |
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² image Ù…Ø¹ØªØ¨Ø±
        docker run -d \
          --name openbullet2 \
          -p 8080:8080 \
          -e ASPNETCORE_URLS=http://0.0.0.0:8080 \
          mrinjamul/openbullet2:latest
        
        # Ù…Ù†ØªØ¸Ø± Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ
        sleep 30
        
        # Ø¨Ø±Ø±Ø³ÛŒ container
        if docker ps | grep -q openbullet2; then
          echo "âœ… OB2 container is running"
          docker logs openbullet2 | head -20
        else
          echo "âŒ OB2 container failed"
          docker logs openbullet2
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 15

    - name: Display access information
      run: |
        URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "========================================"
        echo "ğŸ‰ OPENBULLET2 READY!"
        echo "========================================"
        echo "ğŸŒ Access URL: $URL"
        echo "ğŸ‘¤ Username: admin"
        echo "ğŸ” Password: admin"
        echo "â° Will run for 4 hours"
        echo "========================================"

    - name: Keep container running
      run: |
        # Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ container
        counter=0
        while [ $counter -lt 240 ]; do
          if ! docker ps | grep -q openbullet2; then
            echo "âŒ Container stopped, restarting..."
            docker start openbullet2
          fi
          sleep 60
          counter=$((counter + 1))
        done
