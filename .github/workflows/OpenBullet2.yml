name: OpenBullet2 Windows Complete

on:
  workflow_dispatch

jobs:
  deploy-ob2-windows:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout and build
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        
        # build کامل
        dotnet restore
        dotnet build -c Release
        dotnet publish -c Release -o ./publish

    - name: Verify build output
      run: |
        cd OpenBullet2/publish
        echo "=== Published Files ==="
        dir
        echo "=== wwwroot Contents ==="
        if (Test-Path wwwroot) {
            dir wwwroot
            echo "✅ Static files are present"
        } else {
            echo "❌ wwwroot missing - this was the Linux issue!"
        }

    - name: Start OpenBullet2
      run: |
        cd OpenBullet2/publish
        $process = Start-Process -PassThru -FilePath "dotnet" -ArgumentList "OpenBullet2.Web.dll", "--urls", "http://0.0.0.0:8080"
        echo "PROCESS_ID=$process.Id" >> $env:GITHUB_ENV
        Start-Sleep -Seconds 40

    - name: Verify application
      run: |
        # تست اتصال به برنامه
        try {
            $response = Invoke-WebRequest -Uri "http://localhost:8080" -TimeoutSec 10
            echo "✅ OpenBullet2 is fully functional!"
            echo "✅ Static files are serving correctly"
        } catch {
            echo "❌ Application error: $($_.Exception.Message)"
            exit 1
        }

    - name: Setup Ngrok tunnel
      run: |
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive -Path "ngrok.zip" -DestinationPath "."
        .\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "http", "8080"
        Start-Sleep -Seconds 30

    - name: Retrieve public URL
      run: |
        $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
        $publicUrl = $tunnels.tunnels[0].public_url
        echo "PUBLIC_URL=$publicUrl" >> $env:GITHUB_ENV
        
        Write-Host ""
        Write-Host "✨ SUCCESS! OpenBullet2 is fully working on Windows"
        Write-Host "🌐 Access URL: $publicUrl"
        Write-Host ""

    - name: Keep alive
      run: |
        Write-Host "🟢 Service running on Windows for 6 hours..."
        Start-Sleep -Seconds 21600
