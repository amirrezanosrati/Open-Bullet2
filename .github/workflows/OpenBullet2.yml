name: OpenBullet2 Auto Path Finder

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Install .NET 6.0
      run: |
        sudo apt-get update
        sudo apt-get install -y dotnet-sdk-6.0 wget
        dotnet --version

    - name: Clone OB2 repository
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        echo "ğŸ“ Repository structure:"
        find . -type f -name "*.csproj" -o -name "*.sln" | head -10

    - name: Find the correct project path
      run: |
        cd OpenBullet2
        # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ csproj
        CSPROJ_FILE=$(find . -name "*.csproj" | grep -v "test" | head -1)
        if [ -z "$CSPROJ_FILE" ]; then
          echo "âŒ No .csproj file found"
          echo "Available files:"
          find . -type f | head -20
          exit 1
        fi
        echo "âœ… Found project file: $CSPROJ_FILE"
        echo "CSPROJ_FILE=$CSPROJ_FILE" >> $GITHUB_ENV
        
        # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
        PROJECT_DIR=$(dirname "$CSPROJ_FILE")
        echo "ğŸ“ Project directory: $PROJECT_DIR"
        echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

    - name: Build the project
      run: |
        cd OpenBullet2
        echo "ğŸ”¨ Building project: $CSPROJ_FILE"
        dotnet build "$CSPROJ_FILE" --configuration Release

    - name: Run OB2 from correct path
      run: |
        cd OpenBullet2
        echo "ğŸš€ Running from: $PROJECT_DIR"
        cd "$PROJECT_DIR"
        dotnet run --configuration Release --urls="http://0.0.0.0:8080" > run.log 2>&1 &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30

    - name: Check if OB2 is running
      run: |
        echo "ğŸ” Checking OB2 status..."
        if ps -p $OB2_PID > /dev/null; then
          echo "âœ… OB2 process is running (PID: $OB2_PID)"
          echo "ğŸ“‹ Application log:"
          cat OpenBullet2/"$PROJECT_DIR"/run.log | tail -20
        else
          echo "âŒ OB2 process not found"
          echo "ğŸ“‹ Full error log:"
          cat OpenBullet2/"$PROJECT_DIR"/run.log
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 10

    - name: Get public URL
      run: |
        sleep 10
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "ğŸŒ Public URL: $PUBLIC_URL"
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV

    - name: Display success message
      run: |
        echo "========================================"
        echo "ğŸ‰ OPENBULLET2 IS RUNNING!"
        echo "========================================"
        echo "ğŸŒ URL: $PUBLIC_URL"
        echo "ğŸ‘¤ Username: admin"
        echo "ğŸ” Password: admin"
        echo "========================================"

    - name: Keep alive
      run: |
        sleep 14400
