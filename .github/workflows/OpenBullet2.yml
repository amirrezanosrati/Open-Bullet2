name: OpenBullet2 Build Only Web Project

on:
  workflow_dispatch

jobs:
  build-ob2-web:
    runs-on: ubuntu-latest

    steps:
    - name: Install .NET 6.0
      run: |
        # نصب .NET 6.0 به روش صحیح
        wget https://dot.net/v1/dotnet-install.sh
        chmod +x dotnet-install.sh
        ./dotnet-install.sh --runtime dotnet --version 6.0.0
        export PATH="$PATH:/root/.dotnet"

    - name: Clone and build only web project
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        
        # فقط پروژه وب را build کن (بدون پروژه‌های desktop)
        if [ -f "OpenBullet2.Web/OpenBullet2.Web.csproj" ]; then
          dotnet restore OpenBullet2.Web/OpenBullet2.Web.csproj
          dotnet build OpenBullet2.Web/OpenBullet2.Web.csproj --configuration Release
          dotnet publish OpenBullet2.Web/OpenBullet2.Web.csproj --configuration Release --output ./publish
        else
          echo "❌ Web project not found"
          exit 1
        fi

    - name: Run web application
      run: |
        cd OpenBullet2/publish
        dotnet OpenBullet2.Web.dll --urls "http://0.0.0.0:8080" &
        sleep 40

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 &
        sleep 15

    - name: Display URL
      run: |
        URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "OpenBullet2 Web: $URL"

    - name: Keep running
      run: |
        sleep 21600
