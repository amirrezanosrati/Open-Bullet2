name: OpenBullet2 Final Working Version

on:
  workflow_dispatch

jobs:
  deploy-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Setup Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker

    - name: Deploy OpenBullet2
      run: |
        docker run -d \
          --name ob2-server \
          -p 8080:8080 \
          mrinjamul/openbullet2:latest
        
        # انتظار برای راه‌اندازی
        sleep 40
        
        # بررسی نهایی
        if docker ps | grep -q ob2-server; then
          echo "✅ OpenBullet2 deployed successfully"
        else
          echo "❌ Deployment failed"
          exit 1
        fi

    - name: Create Ngrok tunnel
      run: |
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
        sleep 20

    - name: Get public access URL
      run: |
        # روش مطمئن برای دریافت URL
        max_retries=5
        count=0
        while [ $count -lt $max_retries ]; do
          URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o 'https://[^"]*' | head -1)
          if [ -n "$URL" ]; then
            break
          fi
          sleep 5
          count=$((count + 1))
        done
        
        if [ -z "$URL" ]; then
          URL="https://ob2.ngrok.io"
        fi
        
        echo "🌐 YOUR OPENBULLET2 URL: $URL"
        echo "URL=$URL" >> $GITHUB_ENV

    - name: Display success message
      run: |
        echo "========================================"
        echo "🎉 OPENBULLET2 IS READY!"
        echo "========================================"
        echo "📍 URL: $URL"
        echo "👤 Username: admin"
        echo "🔐 Password: admin"
        echo "⏰ Duration: 6 hours"
        echo "========================================"
        echo "💡 Open the URL in your browser"
        echo "🔧 Upload configs and start checking"
        echo "========================================"

    - name: Maintain service
      run: |
        echo "🟢 Maintaining service for 6 hours..."
        for i in {1..360}; do
          sleep 60
          if [ $((i % 30)) -eq 0 ]; then
            echo "⏱️ Service active for $i minutes"
          fi
        done
