name: OpenBullet2 with Ngrok

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      APP_PORT: "50001"   # پورت 5 رقمی سفارشی

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # نصب .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # گرفتن آخرین Release و Asset ویندوز
      - name: Fetch latest OpenBullet2 release
        id: get_release
        shell: pwsh
        run: |
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/openbullet/OpenBullet2/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -match "win.*x64.*\.zip" }
          if (-not $asset) { throw "❌ No Windows asset found in latest release." }
          Write-Host "Downloading $($asset.name)..."
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "ob2.zip"
          Expand-Archive ob2.zip -DestinationPath ob2
          echo "ASSET_NAME=$($asset.name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      # اجرای OpenBullet2 روی پورت دلخواه
      - name: Run OpenBullet2
        run: |
          cd ob2/OpenBullet2Web
          $env:ASPNETCORE_URLS="http://*:$env:APP_PORT"
          dotnet OpenBullet2Web.dll &
          Start-Sleep -Seconds 20

      # دانلود ngrok نسخه جدید
      - name: Download latest ngrok
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip -DestinationPath .
          dir .

      # راه‌اندازی تونل ngrok روی پورت سفارشی
      - name: Start ngrok tunnel
        id: ngrok
        run: |
          .\ngrok.exe authtoken $env:NGROK_TOKEN
          Start-Process -FilePath .\ngrok.exe -ArgumentList "http",$env:APP_PORT,"--log=stdout" -NoNewWindow
          Start-Sleep -Seconds 10

          $tunnelsJson = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
          $publicUrl = $tunnelsJson.tunnels[0].public_url
          Write-Host "Public URL: $publicUrl"
          echo "NGROK_URL=$publicUrl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          echo "::set-output name=url::$publicUrl"

      # تست اتصال به OpenBullet2
      - name: Test OB2 connection
        run: |
          Invoke-RestMethod -Uri "http://localhost:$env:APP_PORT" -UseBasicParsing

      # نمایش آدرس خروجی
      - name: Show access URL
        run: |
          Write-Host "===================================="
          Write-Host " OpenBullet2 Web Client is running! "
          Write-Host " Public URL: $env:NGROK_URL "
          Write-Host " Release Asset: $env:ASSET_NAME "
          Write-Host "===================================="
