name: OpenBullet2 - Skip Build, Use Published Version

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Download pre-built OpenBullet2
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø² GitHub Releases Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ build
        wget -O OpenBullet2 "https://github.com/openbullet/OpenBullet2/releases/download/2.0.0/OpenBullet2"
        chmod +x OpenBullet2
        file OpenBullet2
        echo "âœ… Pre-built binary downloaded"

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libc6 \
          libgdiplus \
          libssl3 \
          libicu70 \
          ca-certificates
        echo "âœ… Runtime dependencies installed"

    - name: Run OpenBullet2 directly
      run: |
        # Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… binary
        ./OpenBullet2 --urls "http://0.0.0.0:8080" > ob2.log 2>&1 &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 60  # Ø²Ù…Ø§Ù† Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
        
        if ps -p $OB2_PID > /dev/null; then
          echo "âœ… OpenBullet2 is running"
          echo "ğŸ“‹ Startup output:"
          tail -30 ob2.log
        else
          echo "âŒ Failed to start OpenBullet2"
          echo "ğŸ“‹ Full log:"
          cat ob2.log
          exit 1
        fi

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 20

    - name: Get public URL
      run: |
        sleep 15
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        if [ -z "$PUBLIC_URL" ]; then
          PUBLIC_URL=$(grep -o 'url=https://[^ ]*' ngrok.log | cut -d= -f2 | head -1)
        fi
        echo "ğŸŒ Public URL: $PUBLIC_URL"
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV

    - name: Display success message
      run: |
        echo "========================================"
        echo "ğŸ‰ OPENBULLET2 IS READY!"
        echo "========================================"
        echo "ğŸŒ URL: $PUBLIC_URL"
        echo "ğŸ‘¤ Username: admin"
        echo "ğŸ” Password: admin"
        echo "â° Running for 6 hours"
        echo "========================================"

    - name: Keep service alive
      run: |
        echo "ğŸŸ¢ Service running for 6 hours..."
        sleep 21600
