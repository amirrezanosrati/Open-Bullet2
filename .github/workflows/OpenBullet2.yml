name: OpenBullet2 Build from Source

on:
  workflow_dispatch

jobs:
  build-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
    - name: Install .NET 6.0 correctly
      run: |
        # ŸÜÿµÿ® .NET ÿ®ÿß ÿ±Ÿàÿ¥ ÿµÿ≠€åÿ≠
        wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
        chmod +x dotnet-install.sh
        ./dotnet-install.sh --channel 6.0 --install-dir /usr/share/dotnet
        export PATH="$PATH:/usr/share/dotnet"
        dotnet --version

    - name: Clone and build OB2
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        
        # Ÿæ€åÿØÿß ⁄©ÿ±ÿØŸÜ ŸÅÿß€åŸÑ Ÿæÿ±Ÿà⁄òŸá
        CSPROJ=$(find . -name "*.csproj" | head -1)
        echo "üìÑ Project file: $CSPROJ"
        
        # build Ÿæÿ±Ÿà⁄òŸá
        dotnet restore
        dotnet build --configuration Release
        dotnet publish --configuration Release --output ./publish

    - name: Run published application
      run: |
        cd OpenBullet2/publish
        dotnet OpenBullet2.dll --urls "http://0.0.0.0:8080" > app.log 2>&1 &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30
        
        if ps -p $OB2_PID > /dev/null; then
          echo "‚úÖ OB2 running from source"
          cat app.log | head -10
        else
          echo "‚ùå Failed to run from source"
          cat app.log
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 &
        sleep 15

    - name: Show URL
      run: |
        URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "OpenBullet2: $URL"

    - name: Wait
      run: |
        sleep 21600
