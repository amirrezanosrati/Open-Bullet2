name: OpenBullet2 Correct Download

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Download OB2 Linux binary
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ ØµØ­ÛŒØ­ Ø§Ø² GitHub Releases
        DOWNLOAD_URL=$(curl -s https://api.github.com/repos/openbullet/OpenBullet2/releases/latest | grep "browser_download_url" | grep -i linux | cut -d'"' -f4)
        echo "Download URL: $DOWNLOAD_URL"
        
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
        wget -O OpenBullet2 "$DOWNLOAD_URL"
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„
        file OpenBullet2
        chmod +x OpenBullet2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgdiplus \
          libc6-dev \
          libx11-dev

    - name: Run OB2
      run: |
        mkdir -p ob2-data
        cd ob2-data
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ OB2
        ../OpenBullet2 --urls "http://0.0.0.0:8080" &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30

    - name: Check if OB2 is running
      run: |
        if ps -p $OB2_PID > /dev/null; then
          echo "âœ… OB2 is running"
        else
          echo "âŒ OB2 failed to start"
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > /dev/null 2>&1 &
        sleep 10

    - name: Get public URL
      run: |
        sleep 10
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "ğŸŒ Public URL: $PUBLIC_URL"
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV

    - name: Keep alive
      run: |
        echo "âœ… OpenBullet2 is running at: $PUBLIC_URL"
        echo "ğŸ”‘ Username: admin"
        echo "ğŸ”‘ Password: admin"
        echo "â° Will run for 4 hours..."
        sleep 14400
