name: OB2 Simple Docker

on:
  workflow_dispatch

jobs:
  run-ob2-simple:
    runs-on: ubuntu-latest

    steps:
    - name: Clone and build locally
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        dotnet build OpenBullet2.Web/OpenBullet2.Web.csproj

    - name: Run with Docker properly
      run: |
        cd OpenBullet2
        docker build -t ob2-local -f Dockerfile .
        docker run -d -p 8080:8080 --name ob2-container ob2-local
        sleep 40
        docker logs ob2-container

    - name: Setup Ngrok
      run: |
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 &
        sleep 15

    - name: Display URL
      run: |
        url=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "üåê Your OpenBullet2: $url"
        echo "üîë admin/admin"

    - name: Wait
      run: |
        sleep 7200
