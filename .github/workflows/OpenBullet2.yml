name: OpenBullet2 Guaranteed Working

on:
  workflow_dispatch

jobs:
  deploy-ob2:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
    - name: Download OpenBullet2 Release
      run: |
        # دانلود مستقیم از ریلیزهای گیتهاب
        $releaseUrl = "https://github.com/openbullet/OpenBullet2/releases/latest/download/OpenBullet2.zip"
        Invoke-WebRequest -Uri $releaseUrl -OutFile "OpenBullet2.zip"
        Expand-Archive -Path "OpenBullet2.zip" -DestinationPath "OpenBullet2" -Force
        cd OpenBullet2
        dir

    - name: Run OpenBullet2
      run: |
        cd OpenBullet2
        Start-Process -FilePath "OpenBullet2.exe" -ArgumentList "--urls", "http://0.0.0.0:8080"
        Start-Sleep -Seconds 30

    - name: Setup Ngrok
      run: |
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive -Path "ngrok.zip" -DestinationPath "." -Force
        .\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "http", "8080"
        Start-Sleep -Seconds 20

    - name: Get URL
      run: |
        Start-Sleep -Seconds 10
        $url = (Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels").tunnels[0].public_url
        echo "URL: $url"
        echo "Username: admin"
        echo "Password: admin"

    - name: Wait
      run: |
        Start-Sleep -Seconds 1800
