name: Build & Expose OpenBullet2 Web Client via ngrok

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  web-client-ngrok:
    runs-on: windows-latest

    env:
      APP_PORT: '5000'
      NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
      # نسخه دقیق OpenBullet2 که می‌خوای دانلود کنی:
      OB2_VERSION: '0.3.2'  # یا هر نسخه‌ای که آماده است

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0
          lfs: true

      - name: Download OpenBullet2 Web Client (Release asset)
        run: |
          Write-Host "Fetching OpenBullet2 version $env:OB2_VERSION"
          $assetName = "OpenBullet2.Web.zip"
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/openbullet/OpenBullet2/releases/tags/v$($env:OB2_VERSION)" -Headers @{ 'User-Agent' = 'GitHub-Actions' }
          $asset = $release.assets | Where-Object { $_.name -eq $assetName }
          if (-not $asset) {
            throw "Asset $assetName not found in release v$($env:OB2_VERSION)"
          }
          $downloadUrl = $asset.browser_download_url
          Invoke-WebRequest -Uri $downloadUrl -OutFile $assetName
          Expand-Archive -Path $assetName -DestinationPath "./OpenBullet2Web"

      - name: Ensure .NET Runtime & ASP.NET Core Runtime installed
        run: |
          # فرض می گیریم که روی runner ویندوز-latest هست
          # نصب دات‌نت، اگر نیاز باشد — معمولاً روی ویندوز-latest نسخه های پایه وجود دارد
          # اگر نیاز باشه، می‌تونی نصب دستی اضافه کنی

          dotnet --list-runtimes
          dotnet --list-sdks

      - name: Download ngrok for Windows
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "./ngrok"
          # مسیر بنر ی باینری
          $ngrokExe = "./ngrok/ngrok.exe"

      - name: Run OpenBullet2 Web Client (background)
        working-directory: "./OpenBullet2Web"
        run: |
          Write-Host "Starting OpenBullet2.Web..."
          Start-Process -FilePath ".\\OpenBullet2.Web.exe" -ArgumentList "--urls","http://0.0.0.0:$env:APP_PORT" -NoNewWindow
          # صبر کوتاه برای بالا آمدن سرور
          Start-Sleep -Seconds 10

      - name: Start ngrok and fetch public URL
        run: |
          if (-not $env:NGROK_TOKEN) {
            throw "NGROK_TOKEN secret not set."
          }
          $ngrokExe = "../ngrok/ngrok.exe"
          # authtoken تنظیم میشه
          & $ngrokExe authtoken $env:NGROK_TOKEN
          Start-Process -FilePath $ngrokExe -ArgumentList "http",$env:APP_PORT,"--log=stdout" -NoNewWindow
          # صبر برای آماده شدن تونل
          Start-Sleep -Seconds 10

          # گرفتن URL عمومی
          $tunnelsJson = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
          if (-not $tunnelsJson.tunnels) {
            throw "ngrok tunnels endpoint didn't return tunnels."
          }
          $publicUrl = $tunnelsJson.tunnels[0].public_url
          Write-Host "Public URL: $publicUrl"
          # ذخیره در خروجی اکشن
          echo "NGROK_URL=$publicUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Summary
        run: |
          Write-Host "OpenBullet2 Web Client is available at: $($env:NGROK_URL)"
