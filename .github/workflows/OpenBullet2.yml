name: Simple OpenBullet2 Runner

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install .NET
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y dotnet-sdk-6.0

    - name: Download OB2 source
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        dotnet restore

    - name: Build OB2
      run: |
        cd OpenBullet2
        dotnet build OpenBullet2.csproj --configuration Release

    - name: Start OB2 server
      run: |
        cd OpenBullet2
        dotnet run --project OpenBullet2.csproj --urls="http://0.0.0.0:5000" &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30

    - name: Check if OB2 is running
      run: |
        if ps -p $OB2_PID > /dev/null; then
          echo "✅ OpenBullet2 is running"
        else
          echo "❌ OpenBullet2 failed to start"
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 5000 > /dev/null 2>&1 &
        sleep 10

    - name: Get public URL
      run: |
        sleep 10
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        if [ -z "$PUBLIC_URL" ]; then
          PUBLIC_URL="https://example.ngrok.io"
        fi
        echo "🌐 Public URL: $PUBLIC_URL"
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV

    - name: Keep alive
      run: |
        echo "✅ OpenBullet2 is running at: $PUBLIC_URL"
        echo "🔑 Default password: admin"
        echo "⏰ Will run for 6 hours..."
        
        # نگه داشتن سرویس فعال
        sleep 21600
