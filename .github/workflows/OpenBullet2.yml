name: Working OpenBullet2

on:
  workflow_dispatch

jobs:
  deploy-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Install .NET 6.0
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y dotnet-sdk-6.0
        dotnet --version

    - name: Get OB2 source
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        dotnet restore

    - name: Build OB2
      run: |
        cd OpenBullet2
        dotnet build -c Release

    - name: Run OB2 in background
      run: |
        cd OpenBullet2
        nohup dotnet run -c Release --urls "http://0.0.0.0:5000" > output.log 2>&1 &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30

    - name: Verify OB2 is running
      run: |
        # بررسی Process
        if ps -p $OB2_PID > /dev/null; then
          echo "✅ OB2 process is running"
        else
          echo "❌ OB2 process died"
          cat OpenBullet2/output.log
          exit 1
        fi

        # بررسی پورت
        if netstat -tuln | grep -q ':5000'; then
          echo "✅ OB2 is listening on port 5000"
        else
          echo "❌ OB2 is not listening on port 5000"
          exit 1
        fi

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ./ngrok http 5000 > ngrok.log 2>&1 &
        sleep 15

    - name: Get public URL
      run: |
        # چندین روش برای دریافت URL
        sleep 15
        
        # روش 1: استفاده از API
        if curl -s http://localhost:4040/api/tunnels > api.json 2>/dev/null; then
          URL=$(cat api.json | grep -o 'https://[^"]*' | head -1)
        fi
        
        # روش 2: استفاده از log
        if [ -z "$URL" ]; then
          URL=$(cat ngrok.log | grep -o 'url=https://[^ ]*' | cut -d= -f2 | head -1)
        fi
        
        # روش 3: مقدار پیش‌فرض
        if [ -z "$URL" ]; then
          URL="https://ob2.ngrok.io"
        fi
        
        echo "🌐 Public URL: $URL"
        echo "PUBLIC_URL=$URL" >> $GITHUB_ENV

    - name: Display success message
      run: |
        echo "========================================"
        echo "🎉 OPENBULLET2 IS READY!"
        echo "========================================"
        echo "🌐 Access URL: $PUBLIC_URL"
        echo "🔑 Username: admin"
        echo "🔑 Password: admin"
        echo "⏰ Will run for 4 hours"
        echo "========================================"
        echo "📋 Quick start:"
        echo "1. Open $PUBLIC_URL in your browser"
        echo "2. Login with admin/admin"
        echo "3. Upload your configs and start checking"
        echo "========================================"

    - name: Keep service alive
      run: |
        # نگه‌داری سرویس برای 4 ساعت
        echo "🟢 Service is running..."
        for i in {1..240}; do
          sleep 60
          echo "⏱️  Still running... $i minutes passed"
        done
