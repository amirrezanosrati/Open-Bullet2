name: Working OpenBullet2

on:
  workflow_dispatch

jobs:
  deploy-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Install .NET 6.0
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y dotnet-sdk-6.0
        dotnet --version

    - name: Get OB2 source
      run: |
        git clone https://github.com/openbullet/OpenBullet2.git
        cd OpenBullet2
        dotnet restore

    - name: Build OB2
      run: |
        cd OpenBullet2
        dotnet build -c Release

    - name: Run OB2 in background
      run: |
        cd OpenBullet2
        nohup dotnet run -c Release --urls "http://0.0.0.0:5000" > output.log 2>&1 &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30

    - name: Verify OB2 is running
      run: |
        # Ø¨Ø±Ø±Ø³ÛŒ Process
        if ps -p $OB2_PID > /dev/null; then
          echo "âœ… OB2 process is running"
        else
          echo "âŒ OB2 process died"
          cat OpenBullet2/output.log
          exit 1
        fi

        # Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÙˆØ±Øª
        if netstat -tuln | grep -q ':5000'; then
          echo "âœ… OB2 is listening on port 5000"
        else
          echo "âŒ OB2 is not listening on port 5000"
          exit 1
        fi

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ./ngrok http 5000 > ngrok.log 2>&1 &
        sleep 15

    - name: Get public URL
      run: |
        # Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª URL
        sleep 15
        
        # Ø±ÙˆØ´ 1: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API
        if curl -s http://localhost:4040/api/tunnels > api.json 2>/dev/null; then
          URL=$(cat api.json | grep -o 'https://[^"]*' | head -1)
        fi
        
        # Ø±ÙˆØ´ 2: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² log
        if [ -z "$URL" ]; then
          URL=$(cat ngrok.log | grep -o 'url=https://[^ ]*' | cut -d= -f2 | head -1)
        fi
        
        # Ø±ÙˆØ´ 3: Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        if [ -z "$URL" ]; then
          URL="https://ob2.ngrok.io"
        fi
        
        echo "ğŸŒ Public URL: $URL"
        echo "PUBLIC_URL=$URL" >> $GITHUB_ENV

    - name: Display success message
      run: |
        echo "========================================"
        echo "ğŸ‰ OPENBULLET2 IS READY!"
        echo "========================================"
        echo "ğŸŒ Access URL: $PUBLIC_URL"
        echo "ğŸ”‘ Username: admin"
        echo "ğŸ”‘ Password: admin"
        echo "â° Will run for 4 hours"
        echo "========================================"
        echo "ğŸ“‹ Quick start:"
        echo "1. Open $PUBLIC_URL in your browser"
        echo "2. Login with admin/admin"
        echo "3. Upload your configs and start checking"
        echo "========================================"

    - name: Keep service alive
      run: |
        # Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø³Ø±ÙˆÛŒØ³ Ø¨Ø±Ø§ÛŒ 4 Ø³Ø§Ø¹Øª
        echo "ğŸŸ¢ Service is running..."
        for i in {1..240}; do
          sleep 60
          echo "â±ï¸  Still running... $i minutes passed"
        done
