name: OB2 Pre-built Binary

on:
  workflow_dispatch

jobs:
  run-ob2-binary:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Download OpenBullet2 binary
      run: |
        # دانلود binary از GitHub Releases
        wget -O OpenBullet2 "https://github.com/openbullet/OpenBullet2/releases/latest/download/OpenBullet2"
        chmod +x OpenBullet2
        file OpenBullet2
        echo "✅ Binary downloaded and made executable"

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libc6-dev \
          libgdiplus \
          libx11-dev \
          ca-certificates
        
        echo "✅ Runtime dependencies installed"

    - name: Run OpenBullet2
      run: |
        mkdir -p ob2-data
        cd ob2-data
        ../OpenBullet2 --urls "http://0.0.0.0:8080" > ob2.log 2>&1 &
        echo "OB2_PID=$!" >> $GITHUB_ENV
        sleep 30
        
        # بررسی اجرا
        if ps -p $OB2_PID > /dev/null; then
          echo "✅ OpenBullet2 is running"
          cat ob2.log | head -10
        else
          echo "❌ Failed to start"
          cat ob2.log
          exit 1
        fi

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 15

    - name: Display URL
      run: |
        URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        echo "🌐 URL: $URL"
        echo "🔑 admin/admin"

    - name: Keep alive
      run: |
        sleep 21600  # 6 hours
