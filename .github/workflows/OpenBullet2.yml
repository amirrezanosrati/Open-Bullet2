name: OpenBullet2 Docker - No .NET Needed

on:
  workflow_dispatch

jobs:
  run-ob2:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        echo "âœ… Docker installed successfully"

    - name: Download and run OpenBullet2
      run: |
        # Ú©Ø´ÛŒØ¯Ù† image Ø§Ø² Docker Hub
        docker pull mrinjamul/openbullet2:latest
        echo "âœ… OpenBullet2 image downloaded"
        
        # Ø§Ø¬Ø±Ø§ÛŒ container
        docker run -d \
          --name openbullet2 \
          -p 8080:8080 \
          mrinjamul/openbullet2:latest
        
        # Ù…Ù†ØªØ¸Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
        sleep 30
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª container
        if docker ps | grep -q openbullet2; then
          echo "âœ… OpenBullet2 container is running"
          echo "ğŸ“‹ Container logs:"
          docker logs openbullet2 | head -5
        else
          echo "âŒ Container failed to start"
          docker logs openbullet2
          exit 1
        fi

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8080 > ngrok.log 2>&1 &
        sleep 15

    - name: Get public URL
      run: |
        sleep 15
        # Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª URL
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        
        if [ -z "$PUBLIC_URL" ]; then
          # Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†
          PUBLIC_URL=$(grep -o 'url=https://[^ ]*' ngrok.log | cut -d= -f2 | head -1)
        fi
        
        if [ -z "$PUBLIC_URL" ]; then
          PUBLIC_URL="https://ob2.ngrok.io"
        fi
        
        echo "ğŸŒ Public URL: $PUBLIC_URL"
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV

    - name: Display access information
      run: |
        echo "========================================"
        echo "ğŸ‰ OPENBULLET2 IS READY!"
        echo "========================================"
        echo "ğŸŒ Access URL: $PUBLIC_URL"
        echo "ğŸ‘¤ Username: admin"
        echo "ğŸ” Password: admin"
        echo "â° Will run for 6 hours"
        echo "========================================"
        echo "ğŸ’¡ Open the URL in your browser to access OpenBullet2"

    - name: Keep service running
      run: |
        echo "ğŸŸ¢ Service is running..."
        counter=0
        while [ $counter -lt 360 ]; do  # 6 hours
          # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
          if [ $((counter % 5)) -eq 0 ]; then
            if docker ps | grep -q openbullet2; then
              echo "âœ… All services healthy - $counter minutes elapsed"
            else
              echo "âš ï¸ Container issues detected"
              docker start openbullet2 || true
            fi
          fi
          sleep 60
          counter=$((counter + 1))
        done
